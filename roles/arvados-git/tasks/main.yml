---
# tasks file for arvados-git
- name: Install runit external yum repo
  shell: curl -s https://packagecloud.io/install/repositories/imeyer/runit/script.rpm.sh | sudo bash

- name: Install Arvados GIT server and dependencies
  sudo: yes
  yum: name={{ item }} state=latest update_cache=yes
  with_items:
    - git
    - perl-Data-Dumper-Names
    - openssh-server
    - gitolite3
    - arvados-git-httpd
    - runit

- name: Create git group
  sudo: yes
  group: name="{{ git_user_name }}" state=present

- name: Add git user and generate SSH keys
  sudo: yes
  user: name="{{ git_user_name }}" shell=/bin/bash group="{{ git_user_name }}" home="{{ git_user_home }}" generate_ssh_key=yes ssh_key_bits=2048

- name: Create arvados git dir
  sudo: yes
  file: name="{{ git_user_home }}" state=directory owner="{{ git_user_name }}" group="{{ git_user_name }}"

- name: Create arvados git (bin) dir
  become: yes
  become_user: "{{ git_user_name }}"
  become_method: sudo
  file: name="{{ git_user_home }}/bin" state=directory owner="{{ git_user_name }}" group="{{ git_user_name }}"

- name: Create gitolite runit service dir
  sudo: yes
  file: name="{{ gitolite_runit }}" state=directory

- name: Setting up runit config for gitolite
  sudo: yes
  template: src="gitolite.runit.j2" dest="{{ gitolite_runit }}/run" mode=700
